(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{480:function(e,a,t){"use strict";t.r(a);var s=t(28),r=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"混合开发jsbridge及原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#混合开发jsbridge及原理"}},[e._v("#")]),e._v(" 混合开发jsBridge及原理？")]),e._v(" "),t("p",[e._v("混合开发使用少不了原生与js之间的方法互调，解决方案就是"),t("a",{attrs:{href:"https://github.com/wendux/DSBridge-Android/blob/master/readme-chs.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("Dsbridge"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"使用方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[e._v("#")]),e._v(" 使用方法")]),e._v(" "),t("ul",[t("li",[e._v("初始化dsBridge")])]),e._v(" "),t("blockquote",[t("p",[e._v("/cdn方式引入初始化代码(中国地区慢，建议下载到本地工程)\n//"),t("script",{attrs:{src:"https://unpkg.com/dsbridge@3.1.3/dist/dsbridge.js"}}),e._v('\n//npm方式安装初始化代码\n//npm install dsbridge@3.1.3\nvar dsBridge=require("dsbridge")')])]),e._v(" "),t("h3",{attrs:{id:"原生传递值给js"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原生传递值给js"}},[e._v("#")]),e._v(" 原生传递值给js")]),e._v(" "),t("ul",[t("li",[e._v("js定义一个函数")])]),e._v(" "),t("p",[e._v("js接受传值，直接通过dsBridge.register()方法接受，第一个参数是约定好的注册名与原生保持一致，\n第二个参数js方法，data就是原生传递的值，方法的return 返回值就是传递给原生的")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('dsBridge.register(\'addValue\', function (data) {\n  var value = JSON.parse(data);\n  document.getElementById("test").innerHTML = value.html;\n  return "success"\n});\n')])])]),t("ul",[t("li",[e._v("原生通过webview去调用")])]),e._v(" "),t("p",[e._v("通过webView.callHandler()方法 将第一个参数约定为注册函数的名称，与js相同\n第二个参数是需要传递的值；第三个参数是接受js返回的回调，可用于js接受成功后再去通知原生。")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('dwebView.callHandler("addValue",new Object[]{3,4},new OnReturnValue<Integer>(){\n  @Override\n  public void onValue(Integer retValue) {\n    Log.d("jsbridge","call succeed,return value is "+retValue);\n  }\n});\n')])])]),t("h3",{attrs:{id:"js传值给原生-js调用原生fun"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#js传值给原生-js调用原生fun"}},[e._v("#")]),e._v(" js传值给原生(js调用原生fun)")]),e._v(" "),t("ul",[t("li",[e._v("原生通过addJavascriptObject注册一个方法")])]),e._v(" "),t("blockquote",[t("p",[e._v("方法名与注册名一致；第一个参数是传递的值；第二个参数可回调信息给js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('public class JsEchoApi {\n  @JavascriptInterface\n  public Object syn(Object args) throws JSONException {\n    return  args;\n  }\n\n  @JavascriptInterface\n  public void asyn(Object args,CompletionHandler handler){\n    handler.complete(args);\n  }\n}\n//namespace is "echo"\ndwebView.addJavascriptObject(new JsEchoApi(),"echo");\n')])])]),t("ul",[t("li",[e._v("js通过dsBridge调用")])]),e._v(" "),t("blockquote",[t("p",[e._v("第一个参数是约定注册的名称，与原生接受处方法名一致；   第二个参数是要传递的值；   第三个参数是接受原生返回的回调。")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('// call echo.syn\nvar ret=dsBridge.call("echo.syn",{msg:" I am echoSyn call", tag:1})\nalert(JSON.stringify(ret))  \n// call echo.asyn\ndsBridge.call("echo.asyn",{msg:" I am echoAsyn call",tag:2},function (ret) {\n  alert(JSON.stringify(ret));\n})\n')])])]),t("p",[t("a",{attrs:{href:"https://github.com/wendux/DSBridge-Android/blob/master/readme-chs.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("DSBridge for Android"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"原理解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原理解析"}},[e._v("#")]),e._v(" 原理解析")]),e._v(" "),t("ul",[t("li",[e._v("js如何调用原生方法")])]),e._v(" "),t("p",[e._v("以安卓为例：")]),e._v(" "),t("p",[e._v("方案一：\n"),t("strong",[e._v("将java对象映射为一个js对象")]),e._v("，并通过Webview提供的方法【addjavascriptinterface|@javascriptinterface】(版本不同api可能不同)将注入到js的window上，这样js就可以调用")]),e._v(" "),t("p",[e._v("方案二：\n"),t("strong",[e._v("系统提供了一些方法也会触发java某些事件的回调")]),e._v(" 例如console，alert，confirm，prompt")]),e._v(" "),t("p",[e._v("安全问题：由于addjavascriptinterface存在"),t("a",{attrs:{href:"https://blog.csdn.net/leehong2005/article/details/11808557",target:"_blank",rel:"noopener noreferrer"}},[e._v("安全问题"),t("OutboundLink")],1),e._v("，因此dsbridge采用两种相结合的方式。")]),e._v(" "),t("ol",[t("li",[e._v("当安卓版本高于 4.2 时，使用 addJavascriptInterface 的方式向 webview 注入 java 的对象；")]),e._v(" "),t("li",[e._v("当安卓版本低于 4.2 的时候，采取给 ua 添加上一串字符串，标注原生已经初始化完 dsbridge 了，此时就采取方法2通信。")])]),e._v(" "),t("p",[e._v("在 js 中，如果在 window 下能够找到通过 addJavascriptInterface 注入的对象，则使用它；\n否则，检查 useragent 中是否存在约定好的字符串（说明原生准备好了 dsbridge），这个时候，一般通过 prompt 来传递信息（因为通过 prompt 接口可以拿到返回值），如")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('prompt("_dsbridge=" + method, arg);\n')])])]),t("ul",[t("li",[e._v("原生如何调用js的方法：")])]),e._v(" "),t("p",[e._v("以安卓为例：")]),e._v(" "),t("p",[e._v("如果原生要调用web的方法，一般需要与web约定好某个挂载在window下的接口，通过 WebView.loadUrl 的方式去调用它。")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("WebView.loadUrl(\"javascript:window.__say_hello('hello, ***')\");\n")])])]),t("p",[e._v("但是这个方法只能调用那个方法，安卓4.4+之后，又多了一个接口evaluateJavascript，这个方法需要两个参数：一个url，以及一个获得返回值的回调函数。")]),e._v(" "),t("p",[e._v("因此，在 dsbridge 中，对这个方法做了封装，如果安卓版本小于4.4，则使用 loadUrl 的方法，否则使用 evaluateJavascript。")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('private void _evaluateJavascript(String script) {\n  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {\n    DWebView.super.evaluateJavascript(script, null);\n  } else {\n    super.loadUrl("javascript:" + script);\n  }\n}\n')])])]),t("p",[e._v("https://www.yuque.com/docs/share/359ce3cd-e9b3-4742-9a41-f18dce553c5c?#")])])}),[],!1,null,null,null);a.default=r.exports}}]);